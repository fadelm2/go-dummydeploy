pipeline {
    agent any

    stages {

        stage('Kill Port 8086') {
            steps {
                sh '''
                    if lsof -t -i:8086 >/dev/null; then
                        lsof -t -i:8086 | xargs kill -9
                    fi
                '''
            }
        }

        stage('Prepare Config') {
            steps {
                configFileProvider(
                    [configFile(fileId: 'configdeploydummy', targetLocation: 'config.json')]
                ) {
                    sh 'cat config.json'
                }
            }
        }

        stage('Rotate Log & Build') {
            steps {
                sh '''
                    if [ -f app.log ]; then
                        mv app.log "app-$(date +%Y%m%d-%H%M%S).log"
                    fi

                    go mod tidy
                    go build -o app

                    ls -lah
                    file app
                '''
            }
        }

        stage('Run App') {
            steps {
                     sh '''
                           echo "Starting app on port 8086..."
                           nohup ./app > app.log 2>&1 &
                            disown

                        # kasih waktu app untuk booting
                        sleep 5

                        echo "=== CHECK PROCESS ==="
                        ps aux | grep '[a]pp'

                        echo "=== CHECK PORT ==="
                        lsof -i :8086 || true

                        echo "=== LOG ==="
                        tail -n 50 app.log
                       '''
            }
        }

        stage('Check Log App') {
            steps {
                sh '''
                    echo "===== LAST 20 LINES OF app.log ====="
                    if [ -f app.log ]; then
                        tail -n 20 app.log
                    else
                        echo "app.log not found!"
                    fi
                '''
            }
        }

    } // <-- ini yang hilang sebelumnya

}
